<!DOCTYPE html>
<meta charset="utf-8">
<style>
	.chart div {
		font: 10px sans-serif;
		background-color: steelblue;
		text-align: right;
		padding: 3px;
		margin: 1px;
		color: white;
	}

	.chart {
		margin-bottom: 10px;
	}

	#results {
		font: 12px sans-serif;
	}
</style>
<html>
<body>
	<div class="chart"></div>
	<div id="results"></div>
<script src="lib/jquery-1.10.2.min.js"></script>
<script src="lib/d3.v3.min.js"></script>
<script>
	//Tally ho!
	function tally() {
		
		//Get the logged data
		$.get("collected_data.txt", function(data) {
			var tally_obj = {};
			var tally_arr = [];
			var lines = data.split("\n");
			var total = 0;
			var out = "";

			//Counting frequency of each rapper
			for (var i in lines) {
				var line = lines[i];
				var name_arr = line.match(/^(.+?(?= from))/);
				var name = "";
				if (name_arr != null) { //use null, not undefined check
					//console.log(line);
					//console.log(name_arr[0]);
					name = name_arr[0];
					if (typeof tally_obj[name] == "undefined") {
						tally_obj[name] = 1;
					}
					else {
						tally_obj[name]++;
					}
					total++;
				}
			}

			//Construct and sort an array of name-count pairs
			//Objects look like {"name":"DJ Dog Dick", "count":"666"}
			for (key in tally_obj) {
				obj = {};
				obj["name"] = key;
				obj["count"] = tally_obj[key];
				//console.log(obj);
				tally_arr.push(obj);
			}
			tally_arr.sort(function(x, y) {
				var xc = x["count"];
				var yc = y["count"];
				if (xc < yc) { //descending
					return 1;
				}
				else if (xc == yc) {
					return 0;
				}
				else {
					return -1;
				}
			});

			//Print results
			out += "Total results: " + total + "<br><br>";
			out += to_s(tally_arr, total);
			$("#results").html(out);
			//console.log(tally_obj);


			//D3 visualization
			d3.select(".chart")
				.selectAll("div")
					.data(tally_arr)
				.enter().append("div")
					.style("width", function(d) {return d.count*10+"px";})
					.text(function(d) {return d.count;});


		}); //end ajax
	}

	//
	//t=tally_arr, n=total
	function to_s(t, n) {
		s = "";
		for (var i in t) {
			var name = t[i]["name"];
			var count = t[i]["count"];
			s += name + ": <b>" + count + "</b> (" + ((count/n)*100).toFixed(2) + "%)" + "<br>";
		}
		return s;
	}


	$(window).load(function() {
		tally();
	});




</script>
</body>
</html>